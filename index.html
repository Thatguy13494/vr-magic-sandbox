<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>VR Magic Sandbox</title>

    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
  </head>

  <body>
    <a-scene
      webxr="optionalFeatures: local-floor, bounded-floor"
      vr-mode-ui="enabled: true"
      background="color: #101018"
    >

      <!-- Lighting -->
      <a-entity light="type: ambient; intensity: 0.7"></a-entity>
      <a-entity light="type: directional; intensity: 0.9" position="1 3 2"></a-entity>

      <!-- Player rig -->
      <a-entity id="rig" position="0 1.6 3">
        <a-camera id="camera"></a-camera>

        <a-entity id="leftHand"  laser-controls="hand: left"></a-entity>
        <a-entity id="rightHand" laser-controls="hand: right" spell-caster></a-entity>
      </a-entity>

      <!-- Ground -->
      <a-plane
        rotation="-90 0 0"
        width="30"
        height="30"
        color="#202030">
      </a-plane>

      <!-- Targets -->
      <a-box class="target" position="-1 1 -3" color="#8844ff"></a-box>
      <a-box class="target" position="0 1 -3"  color="#8844ff"></a-box>
      <a-box class="target" position="1 1 -3"  color="#8844ff"></a-box>

      <!-- Container for spells -->
      <a-entity id="projectiles"></a-entity>

      <script>
        /**********************
         * PROJECTILE MOVEMENT
         **********************/
        AFRAME.registerComponent("projectile", {
          schema: {
            vx: { type: "number" },
            vy: { type: "number" },
            vz: { type: "number" },
            lifeMs: { type: "number", default: 4000 }
          },

          init() {
            this.age = 0;
          },

          tick(t, dt) {
            const p = this.el.object3D.position;
            const s = dt / 1000;

            p.x += this.data.vx * s;
            p.y += this.data.vy * s;
            p.z += this.data.vz * s;

            this.age += dt;
            if (this.age > this.data.lifeMs) {
              this.el.remove();
            }
          }
        });

        function spawnFireOrb(pos, dir, speed = 8) {
          const orb = document.createElement("a-sphere");

          orb.setAttribute("radius", "0.06");
          orb.setAttribute("color", "#ff2a00");
          orb.setAttribute("position", `${pos.x} ${pos.y} ${pos.z}`);

          orb.setAttribute(
            "projectile",
            `vx:${dir.x * speed}; vy:${dir.y * speed}; vz:${dir.z * speed}`
          );

          document.querySelector("#projectiles").appendChild(orb);
        }

        /**********************
         * SPELL CASTING LOGIC
         **********************/
        AFRAME.registerComponent("spell-caster", {
          init() {
            this.lastPos = new THREE.Vector3();
            this.curPos  = new THREE.Vector3();
            this.vel     = new THREE.Vector3();

            this.triggerDown = false;
            this.cooldown = 0;

            this.el.addEventListener("triggerdown", () => this.triggerDown = true);
            this.el.addEventListener("triggerup",   () => this.triggerDown = false);

            this.el.addEventListener("selectstart", () => this.triggerDown = true);
            this.el.addEventListener("selectend",   () => this.triggerDown = false);

            this.el.object3D.getWorldPosition(this.lastPos);
          },

          tick(t, dt) {
            // Velocity tracking
            this.el.object3D.getWorldPosition(this.curPos);
            this.vel.copy(this.curPos).sub(this.lastPos).multiplyScalar(1000 / Math.max(dt, 1));
            this.lastPos.copy(this.curPos);

            // Cooldown
            this.cooldown = Math.max(0, this.cooldown - dt);

            // Detect forward thrust
            const forwardSpeed = -this.vel.z;
            const THRUST_SPEED = 2.2;

            if (this.triggerDown && forwardSpeed > THRUST_SPEED && this.cooldown === 0) {

              // Use CAMERA forward direction (Fix #2)
              const cam = document.querySelector("#camera").object3D;
              const dir = new THREE.Vector3();
              cam.getWorldDirection(dir).normalize();

              const handPos = new THREE.Vector3();
              this.el.object3D.getWorldPosition(handPos);

              spawnFireOrb(handPos, dir);
              this.cooldown = 250; // ms
            }
          }
        });
      </script>
    </a-scene>
  </body>
</html>

